<%# 遅延読み込みのためのスクリプト %>
<%= javascript_include_tag 'https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js' %>
<div id="shelf_buttons" class="shelf_buttons">
    <div class="arrange_shelf">
        <div>
            <button id="show_shelf_side_ico" class="submit_btn_small">本棚を整理</button>
            <button id="hide_shelf_side_ico" class="submit_btn_small hide_shelf_side_ico">整理終了</button>
        </div>
        <a href="/change_shelf_type/<%= @user_setting.shelf_type %>" class="book_type_icon">
            <% if @user_setting.shelf_type == 0 %>
                <%= lazysizes_image_tag 'shelf_type_block' %>
            <% elsif @user_setting.shelf_type == 1 %>
                <%= lazysizes_image_tag 'shelf_type_column' %>
            <% end %>
        </a>
    </div>
    <div id="search_book_button">
        <button class="submit_btn_small">本を探す</button>
    </div>
</div>
    <div class="search_button">
        <%= form_with(url: books_search_path ) do |f| %>
          <div class="search_book_keyword_area">
              <%= f.text_field :keyword, placeholder: 'キーワード', class: "search_book_keyword_input_area"%>
              <button class="submit_btn_small">検索する</button>
          </div>
        <% end %>
    </div>
    <div class="scan_book_button">
        <div style="display: none;">
            <canvas id="picture"></canvas>
            <input id="Take-Picture" type="file" accept="image/*;capture=camera" />
            <input type="hidden" name="" id="textbit" value="">
            <input type="hidden" id="barcode" value="">
        </div>
        <button class="submit_btn_small" onclick="clickBarcodeScanButton()">本のバーコードをスキャン</button>
    </div>

<div id="search_book_form"><%# 検索キーワード入力ボックスの設置場所 %></div>

<ul class="shelves_list">
    <li id="add_shelf"><%= lazysizes_image_tag "plus.svg", class: "add_shelf" %></li>
    <li class="shelf_name" value="0"><a href="/shelves/0">すべて</a>&nbsp;&nbsp;
                  </li>
    <% if @shelves %>
        <% @shelves.each do |shelf|%>
            <li class="shelf_name" value="<%= shelf.id %>">
                <span>
                  <a href="/shelves/<%= shelf.id %>"><%= shelf.shelf_name %></a>&nbsp;&nbsp;
                  
                  </span>
            </li>
        <% end %>
    <% end %>
</ul>

<% if @books.present? %>
    <%= form_with(model: @book, url: book_path(@books.ids)) do |form| %>
    <input type="hidden" id="authenticity_token" name="authenticity_token" value="<%= form_authenticity_token %>" >
    <div class="page_wrapper">
        <%= @err %>
            <div id="books_in_shelf" <% if @user_setting.shelf_type == 1 %> class="shelf_type_block" <% end %> >
                <% @books.each do |book| %>
                    <% if @user_setting.shelf_type == 0 %>
                    <div class="book_img_box" id="<%= book.id %>" >
                        <a href="/books/info/<%= book.api_id %>" data-turbolinks="false">
                            <p class="thumbnail_top">
                                <% if book.users_thumbnail.present? %>
                                <%= lazysizes_image_tag book.users_thumbnail_url ,class: "book_img shelf_book", alt:'本の画像' %>
                                <% else %>
                                <%= lazysizes_image_tag book.thumbnail ,class: "book_img shelf_book", alt:'本の画像' %>
                                <% end %>
                            </p>
                        </a>
                        <a href="/impressions/<%= book.impression_link %>" class="shelf_link" data-turbolinks="false">
                            <div class="book_title" id="title_<%= book.id %>">
                                <%= book.title %>
                                <div class="book_count_info">
                                    <p class="book_count">
                                        <%= lazysizes_image_tag "star-on.png" %>
                                        <% if book.evaluation %>
                                            <%= book.evaluation %>
                                        <% else %>
                                        -
                                        <% end %>
                                    </p>
                                    <p class="book_count">
                                        <%= lazysizes_image_tag "impression.svg", class: "book_counter_icon" %>
                                        <%= impression_times(book.id) %>
                                    </p>
                                    <p class="book_count">
                                        <%= lazysizes_image_tag "Twitter_icon_circle.svg", class: "book_counter_icon" %>
                                        <%= tweet_times(book.id) %>
                                    </p>
                               </div>
                            </div>
                        </a>
                        <input id="api_path_<%= book.id %>" type="hidden" name="api_path" value="<%= book.api_path %>" />
                        <div class="shelf_side_ico">
                            <%= lazysizes_image_tag "fire_work.svg", class: "fire_work", id: "destroy_book_#{book.id}" %>
                            <p class="handle"><%= lazysizes_image_tag 'dot_for_handle.svg' %></p>
                        </div>
                    </div>
    <%# 本棚タイプがブロックのとき %>
                    <% elsif @user_setting.shelf_type == 1 %>
                    <input type="hidden" id="current_shelf_id" value="<%= @user_setting.latest_shelf %>">
                    <div id="book_id_<%= book.id %>" class="block_shelf_item" value="<%= book.id %>">
                        <div class="block_shelf_book_and_icon">
                            <a href="/books/info/<%= book.api_id %>" data-turbolinks="false">
                                <p class="thumbnail_block_shelf">
                                    <% if book.users_thumbnail.present? %>
                                        <%= lazysizes_image_tag book.users_thumbnail_url ,class: "shelf_book", alt:'本の画像' %>
                                    <% else %>
                                        <%= lazysizes_image_tag book.thumbnail ,class: " shelf_book", alt:'本の画像' %>
                                    <% end %> <%= book.id %>
                                </p>
                            </a>
                            <div class="shelf_side_ico">
                                <%= lazysizes_image_tag "fire_work.svg", class: "fire_work"%>
                                <ul class="shelf_modal">
                                  <li>本棚を移動</li>
                                      <%= form_with(model: @shelf, url: shelves_path) do |f| %>
                                          <%= f.collection_select :shelf_id, Shelf.where(user_id: current_user.id).rank(:row_order), :id, :shelf_name, include_blank: "選択して下さい" %>
                                          <%= f.hidden_field :book_id, value: book.id %>
                                      <% end %>
                                  <%# if 「すべて」の本棚のとき %>
                                  <li id="<%= book.id %>" class="destroy_book" value="<%= book.id %>">本を削除</li>
                                  <%# end %>
                                </ul>
                                <p class="handle">
                                    <%= lazysizes_image_tag 'dot_for_handle.svg' %>
                                </p>
                            </div>
                        </div>
                        <a href="/impressions/<%= book.impression_link %>" class="shelf_link" data-turbolinks="false">
                                <div class="book_count_info">
                                    <p class="book_count">
                                        <%= lazysizes_image_tag "star-on.png" %>
                                        <% if book.evaluation %>
                                            <%= book.evaluation %>
                                        <% else %>
                                        -
                                        <% end %>
                                    </p>
                                    <p class="book_count">
                                        <%= lazysizes_image_tag "impression.svg", class: "book_counter_icon" %>
                                        <%= impression_times(book.id) %>
                                    </p>
                                    <p class="book_count">
                                        <%= lazysizes_image_tag "Twitter_icon_circle.svg", class: "book_counter_icon" %>
                                        <%= tweet_times(book.id) %>
                                    </p>
                                </div>
                        </a>
                        <input id="api_path_<%= book.id %>" type="hidden" name="api_path" value="<%= book.api_path %>" />
                    </div>
                    <% end %>
        <%#= render "users/shelf_type_column" ←読み込むとエラーになる%> 
                <% end %>
            </div>
    <% end %>
    </div>
<% else %>
    <p>本が登録されていません。</p>
<% end %>
<script type="text/javascript" src="/JOB.js"></script>
<script type="text/javascript">
    // バーコードスキャン用ボタンをクリック
    function clickBarcodeScanButton() {
        $("#Take-Picture").click();
        return false;
    };
    var takePicture = document.querySelector("#Take-Picture"),
    showPicture = document.createElement("img");
    Result = document.querySelector("#textbit");
    sendBarcode = document.querySelector("#barcode");
    // sendBarcode.value = 'aaaaaaa'; // 表示確認
    var canvas =document.getElementById("picture");
    var ctx = canvas.getContext("2d");
    JOB.Init();
    JOB.SetImageCallback(function(result) {
      if(result.length > 0){
        // 検索していることをアラートする
        Swal.fire({
            title: '',
            text: "本を探しているよ！",
            type: 'info',
            timer: 1500, // 1.5秒後に自動的にアラートを閉じる
        })
        var tempArray = [];
        for(var i = 0; i < result.length; i++) {
          // tempArray.push(result[i].Format+" : "+result[i].Value);
          tempArray.push(result[i].Value);
        }
        Result.innerHTML=tempArray.join("<br />");
        sendBarcode.value = tempArray;
      // ajaxを記述
      $.ajax({
          url: "/books/search_from_barcode",
          type: 'post',
          data: { barcode: tempArray,
                  authenticity_token: $("#authenticity_token").val() }
          });
      }else{
        if(result.length === 0) {
        // バーコードの読み取り失敗
        Swal.fire({
            title: '',
            text: "うまくバーコードを読み取れなかったよ。。。",
            type: 'warning',
            timer: 1500, // 1.5秒後に自動的にアラートを閉じる
        })
          // Result.innerHTML="Decoding failed.";
        }
      }
    });
    JOB.PostOrientation = true;
    JOB.OrientationCallback = function(result) {
      // 表示画像のサイズ
      // canvas.width = result.width;
      // canvas.height = result.height;
      canvas.width = 0;
      canvas.height = 0;
      var data = ctx.getImageData(0,0,canvas.width,canvas.height);
      for(var i = 0; i < data.data.length; i++) {
        data.data[i] = result.data[i];
      }
      ctx.putImageData(data,0,0);
    };
    JOB.SwitchLocalizationFeedback(true);
    JOB.SetLocalizationCallback(function(result) {
      ctx.beginPath();
      ctx.lineWIdth = "2";
      ctx.strokeStyle="red";
      for(var i = 0; i < result.length; i++) {
        ctx.rect(result[i].x,result[i].y,result[i].width,result[i].height); 
      }
      ctx.stroke();
    });
    if(takePicture && showPicture) {
      takePicture.onchange = function (event) {
        var files = event.target.files;
        if (files && files.length > 0) {
          file = files[0];
          try {
            var URL = window.URL || window.webkitURL;
            showPicture.onload = function(event) {
              Result.innerHTML="";
              JOB.DecodeImage(showPicture);
              URL.revokeObjectURL(showPicture.src);
            };
            showPicture.src = URL.createObjectURL(file);
          }
          catch (e) {
            try {
              var fileReader = new FileReader();
              fileReader.onload = function (event) {
                showPicture.onload = function(event) {
                  Result.innerHTML="";
                  JOB.DecodeImage(showPicture);
                };
                showPicture.src = event.target.result;
              };
              fileReader.readAsDataURL(file);
            }
            catch (e) {
              Result.innerHTML = "Neither createObjectURL or FileReader are supported";
            }
          }
        }
      };
    }
</script>